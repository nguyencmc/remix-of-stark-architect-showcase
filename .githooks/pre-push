#!/bin/bash

# =============================================================================
# Git Pre-Push Hook - Auto Deploy on Push
# =============================================================================
# Tự động deploy lên server trước khi push (sau khi build thành công)
# =============================================================================

# Get the repository root first
REPO_ROOT=$(git rev-parse --show-toplevel)

# Load environment variables from .env file if exists
if [ -f "$REPO_ROOT/.env" ]; then
    export $(grep -v '^#' "$REPO_ROOT/.env" | xargs)
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
AUTO_DEPLOY_ON_PUSH=${AUTO_DEPLOY_ON_PUSH:-true}
DEPLOY_BRANCH=${DEPLOY_BRANCH:-main}

# Supabase Configuration
VITE_SUPABASE_URL=${VITE_SUPABASE_URL:-}
VITE_SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY:-}

# Deploy Configuration
DEPLOY_USER=${DEPLOY_USER:-root}
DEPLOY_HOST=${DEPLOY_HOST:-}
DEPLOY_PORT=${DEPLOY_PORT:-22}
DEPLOY_PASS=${DEPLOY_PASS:-}
DEPLOY_PATH=${DEPLOY_PATH:-/var/www/myexamtest}

# Get current branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo -e "\n${BLUE}========================================${NC}"
echo -e "${BLUE}  Git Pre-Push Hook${NC}"
echo -e "${BLUE}========================================${NC}"
echo -e "Branch: ${GREEN}$CURRENT_BRANCH${NC}"

# Check if auto deploy on push is enabled
if [ "$AUTO_DEPLOY_ON_PUSH" != "true" ]; then
    echo -e "${YELLOW}Auto deploy on push is disabled.${NC}"
    exit 0
fi

# Check if we're on the deploy branch
if [ "$CURRENT_BRANCH" != "$DEPLOY_BRANCH" ]; then
    echo -e "${YELLOW}Skipping deploy - not on $DEPLOY_BRANCH branch${NC}"
    exit 0
fi

# Get the repository root
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# Run deployment
echo -e "\n${GREEN}Starting deployment before push...${NC}"

if [ -f "./deploy.sh" ]; then
    ./deploy.sh production
    
    if [ $? -eq 0 ]; then
        echo -e "\n${GREEN}✓ Deployment completed! Proceeding with push...${NC}"
    else
        echo -e "\n${RED}✗ Deployment failed! Push aborted.${NC}"
        exit 1
    fi
else
    echo -e "${RED}Error: deploy.sh not found!${NC}"
    exit 1
fi
